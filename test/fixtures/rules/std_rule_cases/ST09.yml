rule: ST09

test_pass_no_join_clauses:
  pass_str: select * from foo

test_pass_no_join_on_conditions:
  pass_str:
    select
        foo.a,
        bar.b
    from foo
    left join bar
        using (a)

test_pass_ignored_subconditions:
  pass_str:
    select
        foo.a,
        bar.b
    from foo
    left join bar
        on bar.a between foo.a and foo.b

test_pass_left_table_first:
  pass_str: |
    select
        foo.a,
        bar.b
    from foo
    left join bar
        on foo.a = bar.a

test_pass_right_table_first:
  pass_str: |
    select
        foo.a,
        bar.b
    from foo
    left join bar
        on bar.a = foo.a

  configs:
    rules:
      structure.first_table:
        preferred_first_table_in_join_clause: right

test_fail_left_table_first:
  fail_str: |
    select
        foo.a,
        bar.b
    from foo
    left join bar
        on foo.a = bar.a

  fix_str: |
    select
        foo.a,
        bar.b
    from foo
    left join bar
        on bar.a = foo.a

  configs:
    rules:
      structure.first_table:
        preferred_first_table_in_join_clause: right

test_fail_right_table_first:
  fail_str: |
    select
        foo.a,
        bar.b
    from foo
    left join bar
        on bar.a = foo.a

  fix_str: |
    select
        foo.a,
        bar.b
    from foo
    left join bar
        on foo.a = bar.a

test_fail_right_table_first_multiple_subconditions:
  fail_str: |
    select
        foo.a,
        foo.b,
        bar.c
    from foo
    left join bar
        on bar.a = foo.a
        and bar.b = foo.b

  fix_str: |
    select
        foo.a,
        foo.b,
        bar.c
    from foo
    left join bar
        on foo.a = bar.a
        and foo.b = bar.b

test_fail_right_table_first_multiple_comparison_operators:
  fail_str: |
    select
        foo.a,
        bar.b,
        baz.c
    from foo
    left join bar
        on bar.a != foo.a
        and bar.b > foo.b
        and bar.c <= foo.c
    left join baz
        on baz.a <> foo.a
        and baz.b >= foo.b
        and baz.c < foo.c

  fix_str: |
    select
        foo.a,
        bar.b,
        baz.c
    from foo
    left join bar
        on foo.a != bar.a
        and foo.b < bar.b
        and foo.c >= bar.c
    left join baz
        on foo.a <> baz.a
        and foo.b <= baz.b
        and foo.c > baz.c

test_fail_right_table_first_subquery:
  fail_str: |
    select
        foo.a,
        bar.b
    from (
        select
            baz.a,
            qux.b
        from baz
        left join qux
            on qux.a = baz.a
    ) foo
    left join bar
        on bar.a = foo.a

  fix_str: |
    select
        foo.a,
        bar.b
    from (
        select
            baz.a,
            qux.b
        from baz
        left join qux
            on baz.a = qux.a
    ) foo
    left join bar
        on foo.a = bar.a

test_fail_right_table_first_cte:
  fail_str: |
    with foo as (
        select
            baz.a,
            qux.b
        from baz
        left join qux
            on qux.a = baz.a
    )
    select
        foo.a,
        bar.b
    from foo
    left join bar
        on bar.a = foo.a

  fix_str: |
    with foo as (
        select
            baz.a,
            qux.b
        from baz
        left join qux
            on baz.a = qux.a
    )
    select
        foo.a,
        bar.b
    from foo
    left join bar
        on foo.a = bar.a

test_fail_right_table_no_join_clause_in_cte:
  fail_str: |
    with foo as (
        select * from bar
    )
    select
        foo.a,
        baz.b
    from foo
    left join baz
        on baz.a = foo.a

  fix_str: |
    with foo as (
        select * from bar
    )
    select
        foo.a,
        baz.b
    from foo
    left join baz
        on foo.a = baz.a

test_fail_right_table_no_join_clause_in_main_query:
  fail_str: |
    with foo as (
        select
            bar.b
        from bar
        left join baz
            on baz.a = bar.a
    )
    select
        b
    from foo

  fix_str: |
    with foo as (
        select
            bar.b
        from bar
        left join baz
            on bar.a = baz.a
    )
    select
        b
    from foo
